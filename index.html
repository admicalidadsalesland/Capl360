<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evaluaci√≥n de Calidad | Buscador por DNI</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f0f5ff 0%, #e6f0ff 100%);
      min-height: 100vh;
      color: #1e293b;
    }

    .fade-in {
      animation: fadeIn 0.4s ease-out forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e2e8f0;
      border-top: 3px solid #4f46e5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .card-hover {
      transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px -8px rgba(0, 0, 0, 0.12);
    }

    input[type="text"]::-webkit-outer-spin-button,
    input[type="text"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
  </style>
</head>

<body class="min-h-screen">

  <!-- üîù MEN√ö FIJO -->
  <header class="fixed top-0 left-0 right-0 bg-white/90 backdrop-blur-xl shadow-sm z-40">
    <nav class="max-w-6xl mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-indigo-600 to-blue-600 flex items-center justify-center text-white font-bold text-sm">QC</div>
        <h1 class="font-semibold text-gray-800 text-lg">Evaluaci√≥n de Calidad</h1>
      </div>
      <div class="flex items-center gap-5 text-sm font-medium text-gray-600">
        <a href="index.html" class="hover:text-indigo-600 transition-colors">Inicio</a>
        <a href="reportes.html" class="hover:text-indigo-600 transition-colors">Reportes</a>
        <a href="configuracion.html" class="hover:text-indigo-600 transition-colors">Configuraci√≥n</a>
        <a href="ayuda.html" class="hover:text-indigo-600 transition-colors">Ayuda</a>
      </div>
    </nav>
  </header>

  <!-- üåê CONTENIDO PRINCIPAL -->
  <main class="pt-28 pb-20 px-4">
    <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden fade-in">
      
      <!-- Encabezado interno -->
      <div class="bg-gradient-to-r from-indigo-50 to-blue-50 px-6 py-5 text-center">
        <h2 class="text-xl font-bold text-gray-800">üîç Buscar Evaluaci√≥n por DNI</h2>
        <p class="text-gray-600 text-sm mt-1">Ingresa el DNI del asesor para ver sus resultados de calidad.</p>
      </div>

      <!-- B√∫squeda -->
      <div class="px-6 py-5">
        <div class="relative max-w-xs mx-auto">
          <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          </div>
          <input
            id="searchInput"
            type="text"
            inputmode="numeric"
            maxlength="8"
            placeholder="Ej: 70234567"
            class="w-full pl-10 pr-4 py-2.5 rounded-lg border border-gray-300 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-300 focus:border-transparent outline-none text-gray-800 text-center text-sm"
          />
        </div>

        <div class="text-center mt-4">
          <button
            id="searchBtn"
            class="px-6 py-2 bg-gradient-to-r from-indigo-600 to-blue-600 text-white text-sm font-medium rounded-lg shadow hover:shadow-md active:scale-[0.98] transition-all"
          >
            Buscar Evaluaci√≥n
          </button>
        </div>

        <!-- Resultados -->
        <section id="resultsContainer" class="hidden mt-6 fade-in">
          <div class="flex justify-between items-center mb-4">
            <p id="infoText" class="text-sm font-medium text-gray-700"></p>
            <button id="resetBtn" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Restablecer
            </button>
          </div>

          <div id="loadingOverlay" class="hidden flex flex-col items-center justify-center py-6">
            <div class="spinner mb-2"></div>
            <p class="text-gray-600 text-sm">Buscando evaluaciones‚Ä¶</p>
          </div>

          <div id="resultsList" class="space-y-4"></div>
        </section>

        <!-- Mensaje inicial -->
        <div id="welcomeMessage" class="text-center text-gray-500 mt-8 text-sm fade-in">
          <div class="inline-block p-2 rounded-full bg-gray-100 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </div>
          <p>Los resultados aparecer√°n aqu√≠ despu√©s de realizar una b√∫squeda por DNI.</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSurBIXBz-zxgpeTzfypry62oOkEvUpRZ-NK7XopbQbCz87sZJFuBUhPTBS17HVxHLuO0kYPe2r3YT0/pub?gid=213572123&single=true&output=csv";
    
    let allData = [];
    let headers = [];

    const resultsContainer = document.getElementById("resultsContainer");
    const welcomeMessage = document.getElementById("welcomeMessage");
    const loadingOverlay = document.getElementById("loadingOverlay");
    const resultsList = document.getElementById("resultsList");
    const infoText = document.getElementById("infoText");

    function showMessage(msg, icon = "success") {
      Swal.fire({
        toast: true,
        position: 'bottom-end',
        icon: icon,
        title: msg,
        showConfirmButton: false,
        timer: 2000,
        customClass: { popup: 'rounded-lg' }
      });
    }

    function getColorClass(value) {
      const num = parseFloat(value);
      if (isNaN(num)) return "text-gray-500";
      if (num >= 85) return "text-green-600";
      if (num >= 70) return "text-yellow-600";
      return "text-red-600";
    }

    function renderResults(rows) {
      resultsList.innerHTML = "";

      if (rows.length === 0) {
        resultsList.innerHTML = `
          <div class="text-center py-8">
            <div class="text-4xl mb-3">üì≠</div>
            <p class="text-gray-600">No se encontraron evaluaciones para ese DNI.</p>
          </div>`;
        return;
      }

      rows.forEach((row) => {
        const dni = row[0] || "‚Äî";
        const nombre = row[1] || "Asesor sin nombre";
        const notas = row.slice(2, 7);
        let totalValue = 0, valid = 0;

        notas.forEach(v => {
          const num = parseFloat(v);
          if (!isNaN(num)) { totalValue += num; valid++; }
        });

        const promedio = valid ? (totalValue / valid).toFixed(1) : "‚Äî";

        const notaHTML = notas.map((n, i) => `
          <div class="bg-gray-50 rounded-lg p-2.5 text-center">
            <div class="text-[10px] text-gray-500 uppercase tracking-wide">Sem ${i + 1}</div>
            <div class="text-sm font-bold mt-0.5 ${getColorClass(n)}">${n || "‚Äî"}%</div>
          </div>`).join("");

        const card = document.createElement("div");
        card.className = "card-hover bg-white rounded-xl border border-gray-200 p-4 fade-in";
        card.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <h3 class="font-semibold text-gray-800 text-sm">üë§ ${nombre}</h3>
            <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full">${dni}</span>
          </div>
          <div class="grid grid-cols-5 gap-2">${notaHTML}</div>
          <div class="mt-3 pt-3 border-t border-gray-100 text-center">
            <div class="text-[10px] text-gray-500">Promedio General</div>
            <div class="text-lg font-bold text-indigo-700 mt-0.5">${promedio}%</div>
          </div>`;
        resultsList.appendChild(card);
      });

      showMessage("‚úÖ Resultados cargados");
    }

    function searchByDNI(dni) {
      return allData.filter(row => String(row[0]).trim() === dni);
    }

    async function loadCSV() {
      try {
        const response = await fetch(CSV_URL);
        const text = await response.text();
        const parsed = Papa.parse(text, { skipEmptyLines: true });
        headers = parsed.data[0];
        allData = parsed.data.slice(1);
      } catch (err) {
        showMessage("‚ùå Error al cargar los datos", "error");
      }
    }

    document.getElementById("searchBtn").addEventListener("click", () => {
      const raw = document.getElementById("searchInput").value.trim();
      const dni = raw.replace(/\D/g, '');

      if (!/^\d{8}$/.test(dni)) {
        showMessage("‚ö†Ô∏è Ingresa un DNI v√°lido (8 d√≠gitos)", "warning");
        return;
      }

      if (!allData.length) {
        showMessage("‚è≥ Cargando datos‚Ä¶ Intenta en unos segundos", "info");
        return;
      }

      loadingOverlay.classList.remove("hidden");
      resultsContainer.classList.remove("hidden");
      welcomeMessage.classList.add("hidden");

      setTimeout(() => {
        const results = searchByDNI(dni);
        renderResults(results);
        infoText.textContent = `${results.length} resultado${results.length !== 1 ? 's' : ''} encontrado${results.length !== 1 ? 's' : ''}`;
        loadingOverlay.classList.add("hidden");
      }, 500);
    });

    document.getElementById("searchInput").addEventListener("keydown", e => {
      if (e.key === "Enter") document.getElementById("searchBtn").click();
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("searchInput").value = "";
      resultsContainer.classList.add("hidden");
      welcomeMessage.classList.remove("hidden");
      resultsList.innerHTML = "";
      infoText.textContent = "";
      showMessage("üîÑ B√∫squeda restablecida");
    });

    loadCSV();
  </script>
</body>
</html>
